<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ESP32 Self-Balancing Robot</title>
</head>
<body>
  <h1>BLE Control Panel</h1>

  <button onclick="connectBLE()">ðŸ”Œ Connect BLE</button>

  <h3>Set PID Values</h3>
  <label>Kp: <input type="number" id="kp" value="60" step="0.1"></label><br>
  <label>Ki: <input type="number" id="ki" value="270" step="0.1"></label><br>
  <label>Kd: <input type="number" id="kd" value="2.2" step="0.1"></label><br>
  <button onclick="sendPID()">ðŸ“¤ Send PID</button>

  <h3>Live Sensor Data</h3>
  <pre id="output">No data yet</pre>

  <script>
    let bleDevice;
    let bleServer;
    let writeCharacteristic;
    let notifyCharacteristic;

    const serviceUUID = "19b10000-e8f2-537e-4f6c-d104768a1214";
    const charUUID = "19b10001-e8f2-537e-4f6c-d104768a1214";

    async function connectBLE() {
      try {
        bleDevice = await navigator.bluetooth.requestDevice({
          filters: [{ services: [serviceUUID] }]
        });
        bleServer = await bleDevice.gatt.connect();
        const service = await bleServer.getPrimaryService(serviceUUID);
        writeCharacteristic = await service.getCharacteristic(charUUID);
        notifyCharacteristic = await service.getCharacteristic(charUUID);

        await notifyCharacteristic.startNotifications();
        notifyCharacteristic.addEventListener('characteristicvaluechanged', handleNotification);

        document.getElementById("output").textContent = "âœ… Connected to ESP32";
      } catch (error) {
        console.error(error);
        alert("Failed to connect: " + error);
      }
    }

    function sendPID() {
      if (!writeCharacteristic) return;
      const kp = document.getElementById("kp").value;
      const ki = document.getElementById("ki").value;
      const kd = document.getElementById("kd").value;
      const pidString = `${kp},${ki},${kd}`;
      const encoder = new TextEncoder();
      writeCharacteristic.writeValue(encoder.encode(pidString));
    }

    function handleNotification(event) {
      const decoder = new TextDecoder();
      const data = decoder.decode(event.target.value);
      document.getElementById("output").textContent = data;
    }
  </script>
</body>
</html>
