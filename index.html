<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ESP32 Self-Balancing Robot BLE</title>
</head>
<body>
  <h1>üîß PID Control Panel</h1>

  <button onclick="connectBLE()">üîå Connect to Robot</button>

  <h3>Set PID Values</h3>
  <label>Kp: <input type="number" id="kp" value="60" step="0.1"></label><br>
  <label>Ki: <input type="number" id="ki" value="270" step="0.1"></label><br>
  <label>Kd: <input type="number" id="kd" value="2.2" step="0.1"></label><br>
  <button onclick="sendPID()">üì§ Send PID</button>

  <h3>üì° Live Data from ESP32</h3>
  <pre id="output">Waiting for data...</pre>

  <script>
    let device, server;
    let writeChar, notifyChar;

    const SERVICE_UUID       = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
    const WRITE_UUID         = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";
    const NOTIFY_UUID        = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";

    async function connectBLE() {
      try {
        device = await navigator.bluetooth.requestDevice({
          filters: [{ services: [SERVICE_UUID] }]
        });
        server = await device.gatt.connect();

        const service = await server.getPrimaryService(SERVICE_UUID);
        writeChar = await service.getCharacteristic(WRITE_UUID);
        notifyChar = await service.getCharacteristic(NOTIFY_UUID);

        await notifyChar.startNotifications();
        notifyChar.addEventListener("characteristicvaluechanged", handleNotification);

        document.getElementById("output").textContent = "‚úÖ Connected to ESP32. Waiting for data...";
      } catch (error) {
        console.error(error);
        alert("Failed to connect: " + error);
      }
    }

    function sendPID() {
      if (!writeChar) {
        alert("‚ùå Not connected to ESP32 yet!");
        return;
      }
      const kp = document.getElementById("kp").value;
      const ki = document.getElementById("ki").value;
      const kd = document.getElementById("kd").value;
      const data = `${kp},${ki},${kd}`;
      const encoder = new TextEncoder();
      writeChar.writeValue(encoder.encode(data));
    }

    function handleNotification(event) {
      const decoder = new TextDecoder();
      const value = decoder.decode(event.target.value);
      document.getElementById("output").textContent = value;
    }
  </script>
</body>
</html>
